# ===============================================
# TensorFlow Keras による最小線形層の動作確認（解説付き・GPU有効）
# ---------------------------------------------------------------
# ・入力次元: 2
# ・出力次元: 4（units=4 の全結合層 Dense）
# ・活性化  : 既定（None）→ 線形 y = xW + b
# ・目的    : 重み/バイアスの形状と、単一サンプル通過時の入出力形状を確認する
#   - W の形状は (input_dim, units) = (2, 4)
#   - b の形状は (units,) = (4,)
#   - 入力 x の形状は (batch_size, input_dim) = (1, 2)
#   - 出力 y の形状は (batch_size, units) = (1, 4)
# ・備考    : GPU(Metal) を使用するため、TF_METAL_ENABLED=0 は設定しない。
# ===============================================

import numpy as np
from tensorflow import keras as K
import tensorflow as tf

# ---------------------------------------------------------------
# GPU 利用状況の表示（確認用）
# ---------------------------------------------------------------
gpus = tf.config.list_physical_devices("GPU")
print("Physical GPUs:", gpus)

# ---------------------------------------------------------------
# モデル定義: 1 層のみの順伝播モデル（Sequential）
# Dense(units=4, input_shape=(2,)) は、
#   y = x @ W + b  （@ は行列積）を計算する。
# ---------------------------------------------------------------
model = K.Sequential(
    [
        K.layers.Dense(units=4, input_shape=(2,)),  # 入力2→出力4の全結合層
    ]
)

# ---------------------------------------------------------------
# 学習前の初期化済みパラメータ（W, b）を取得して形状を表示
# W: (入力次元=2, 出力次元=4), b: (出力次元=4,)
# ---------------------------------------------------------------
weight, bias = model.layers[0].get_weights()
print("Weight shape is {}.".format(weight.shape))  # 期待: (2, 4)
print("Bias shape is {}.".format(bias.shape))  # 期待: (4,)

# ---------------------------------------------------------------
# ダミー入力を1サンプル分生成
# x の形状は (バッチ=1, 特徴量=2)
# これをモデルに与えると、出力 y は (1, 4) になるはずである。
# ---------------------------------------------------------------
x = np.random.rand(1, 2)
y = model.predict(x, verbose=0)
print("x is ({}) and y is ({}).".format(x.shape, y.shape))  # 期待: x=(1, 2), y=(1, 4)

# ---------------------------------------------------------------
# 【理論メモ】
# 本層は活性化なしの線形射影であるため、
#   y_i = Σ_j x_j * W_{j,i} + b_i  （i=1..4, j=1..2）
# というアフィン変換になる。バッチ次元は先頭軸で保持される。
# ---------------------------------------------------------------
